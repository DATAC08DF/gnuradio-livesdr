#!/bin/sh

. config/config-vars

# Verify read-only overlay of ISO is mounted
[ -f $ISOMNT_RO_SENTINEL ] || {
    echo Read-only ISO mount point not found!
    exit 1
}

# Create read-only mount directory
mkdir -p $ROOTFSMNT_RO || {
    echo Unable to create directory for mounting root filesystem!
    exit 1
}

# Mount root filesystem
echo Mounting squashfs root filesystem read only.
$SUDO $MOUNT -t squashfs -oro $ISOMNT_RO/casper/filesystem.squashfs $ROOTFSMNT_RO || {
    echo Mounting of root filesystem failed!
    exit 1
}

# Create read-write mount directory
# TODO: detect presence of btrfs filesystem and create subvolume instead
mkdir -p $ROOTFSMNT_RW || {
    echo Unable to create directory for mounting root filesystem read-write overlay!
    exit 1
}

# Mount read-write overlay
# TODO: use btrfs seed mount?
echo Mounting squashfs root filesystem read-write overlay.
$SUDO $MOUNT -t overlayfs -olowerdir=$ROOTFSMNT_RO,upperdir=$ROOTFSMNT_RW overlayfs $ROOTFSMNT_RW || {
    echo Mounting of Ubuntu root filesystem read-write overlay failed!
    exit 1
}
