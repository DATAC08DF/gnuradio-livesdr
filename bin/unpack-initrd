#!/bin/sh

. config/config-vars


# Create "mount" points
[ -d $INITRDMNT_RO ] || mkdir -p $INITRDMNT_RO || {
    echo Unable to create initrd read-only unpacking directory.
    exit 1
}

[ -d $INITRDMNT_RW ] || mkdir -p $INITRDMNT_RW || {
    echo Unable to create initrd read-write directory.
    exit 1
}

# Unpack initrd.lz into "read-only" file system
[ "$INITRDMNT_RO" != "" ] || {
    echo INITRDMNT_RO is undefined! Stopping the end of the world.
    exit 1
}
$SUDO rm -rf $INITRDMNT_RO/*

echo Unpacking initrd into read-only directory.
cd $INITRDMNT_RO &&
lzma -dc -S .lz $ISOMNT_RO/casper/initrd.lz | cpio -imd --no-absolute-filenames || {
     echo Unable to unpack initrd into read-only directory.
     exit 1
}

# Create overlay mount for initrd changes
echo Creating read-write overlay for initrd.
$SUDO $MOUNT -t overlayfs -olowerdir=$INITRDMNT_RO,upperdir=$INITRDMNT_RW overlayfs $INITRDMNT_RW || {
     echo Unable to create initrd read-write overlay.
     exit 1
}
