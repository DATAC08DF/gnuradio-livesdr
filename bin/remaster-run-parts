#!/bin/sh
set -o nounset
#set -x #DEBUG

. bin/library.sh

# Exit if already run
[ ! -f stamps/remaster.stamp ] || exit 0

# TODO: export these in config-vars along with anything else needed
# Why is this needed?
export ROOTFSMNT_RW=$ROOTFSMNT_RW
export ISOMNT_RW=$ISOMNT_RW
export SCRIPT_BINDDIR=$SCRIPT_BINDDIR
export CUSTOMDIR=$CUSTOMDIR
export STAMPDIR=$STAMPDIR

# Execute each fragment in config/remaster.d
printinfo Executing remastering scripts...
require_rootfs_rw_mounted
require_chroot_unmounted

run-parts \
    --exit-on-err \
    config/remaster.d || die One or more remaster scripts failed!

printinfo Remaster scripts execution completed.
